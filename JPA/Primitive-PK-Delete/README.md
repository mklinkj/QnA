# Spring JPA Dataì—”í‹°í‹°ì˜ ì •ìˆ˜í˜• ê¸°ë³¸í‚¤ë¥¼ ë˜í¼(Wrapper) íƒ€ì…ì´ ì•„ë‹Œ ì›ì‹œ(Primitive)ë¡œ ì‚¬ìš©í•  ë•Œ.. ê¸°ë³¸í‚¤ ê°’ì´ 0ì´ë¼ë©´ ì‚­ì œê°€ ì•ˆë˜ëŠ” í˜„ìƒ

> Spring JPA Data ë©”ì„œë“œë¡œ ì‚­ì œë¥¼ í–ˆì„ ë•Œ.. ì´ìƒí•˜ê²Œ ì•ˆë˜ì—ˆë˜ ê¸°ì–µì´ ë‚˜ì„œ...
>
> ì´ë²ˆì— í•œë²ˆ í…ŒìŠ¤íŠ¸ í•˜ê¸°ë¡œí•¨.



## ì—”í‹°í‹° í´ë˜ìŠ¤

```java
@Entity
@Table(name = "t_employee")
public class Employee {
  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  private int id; // ì›ì‹œ íƒ€ì…ìœ¼ë¡œ ì„¤ì •

  private String name;
}
```





## DBì˜ ê¸°ë³¸ ìƒíƒœ

í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ì— ì´ˆê¸° ë°ì´í„°ë¥¼ ë„£ì–´ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```sql
DROP TABLE IF EXISTS t_employee CASCADE;
CREATE TABLE IF NOT EXISTS t_employee (
    id    BIGINT        GENERATED BY DEFAULT AS IDENTITY(START WITH 0) PRIMARY KEY,
    name  VARCHAR(255)
);

INSERT INTO t_employee (name) VALUES ('Tomcat');
INSERT INTO t_employee (name) VALUES ('Struts');
INSERT INTO t_employee (name) VALUES ('Spring');
```



## 1. JPA Hibernate í”„ë¡œì íŠ¸ (Spring JPA ë¯¸ì‚¬ìš©)

í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰ìˆœì„œëŠ” ì•„ë˜ì™€ ê°™ì´ í–ˆë‹¤.

1. idê°€ `0`ì¸ ì‚¬ì› ì¡°íšŒì¼ ë•Œ ì¡°íšŒëœ ì‚¬ì›ì´ ìˆëŠ”ì§€ í™•ì¸
2. remove()ë¡œ id `0`ì¸ ì‚¬ì› ì‚­ì œ
3. ì»¤ë°‹
4. idê°€ `0`ì¸ ì‚¬ì› ì¡°íšŒ í–ˆì„ ë•Œ.. ê²°ê³¼ê°€ null ì¸ì§€ í™•ì¸

#### ì•—!!! ê·¸ëŸ°ë°... 2. ë¶€ë¶„ì—ì„œ ì‚­ì œê°€ ì œëŒ€ë¡œ ì•ˆë  ê²ƒì´ë€ ìƒê°ì´ ë“¤ì—ˆëŠ”ë°... ì‚­ì œê°€ ì œëŒ€ë¡œ ëœë‹¤.

```
  ### (1) ì—ì„œ idê°€ 0ì¸ ì‚¬ì› ì¡°íšŒ: ì¡°íšŒë¨ ###
   ...
   Hibernate:
        select
            e1_0.id,
            e1_0.name
        from
            t_employee e1_0
        where
            e1_0.id=?
    05:02:15.311 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]
    05:02:15.313 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([1] : [INTEGER]) - [0]
    05:02:15.313 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([2] : [VARCHAR]) - [Tomcat]
    05:02:15.331 [Test worker] INFO  org.mklinkj.qna.primitive_pk.domain.EmployeeTests - 1st employee id: 0: Employee(id=0, name=Tomcat)
    ....
    
    ### (2) idê°€ 0ì¸ ì‚¬ì› ì‚­ì œ ###
    ### (3) ì»¤ë°‹ì„ í–ˆìœ¼ë‹ˆê¹Œ ì¿¼ë¦¬ ë¡œê·¸ê°€ ì‹¤í–‰ëœ ê²ƒì„ í™•ì¸.
    Hibernate:
        delete
        from
            t_employee
        where
            id=?
    05:02:15.444 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]

    
    ### (4) idê°€ 0ì¸ ì‚¬ì› í™•ì¸ ê²°ê³¼: null. ###
    Hibernate:
        select
            e1_0.id,
            e1_0.name
        from
            t_employee e1_0
        where
            e1_0.id=?
    05:02:15.451 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]
    05:02:15.451 [Test worker] INFO  org.mklinkj.qna.primitive_pk.domain.EmployeeTests - 2nd employee id: 0: null
    05:02:15.452 [Test worker] INFO  org.hibernate.orm.connections.pooling - HHH10001008: Cleaning up connection pool [jdbc:hsqldb:mem:test]
```



ì•„ì§ Spring Data JPAí”„ë¡œì íŠ¸ëŠ” ì˜ˆì œëŠ” ì•„ì§ ì•ˆë§Œë“¤ì—ˆëŠ”ë°... ì¬í™•ì¸ í•´ë´ì•¼ê² ë‹¤. ğŸ‘





## 2. JPA Spring Data JPA í”„ë¡œì íŠ¸

* ì˜ˆì „ ê¸°ì–µì´ í‹€ë ¸ë‚˜ í–ˆëŠ”ë°, Spring Data JPA ë¥¼ ì ìš©í•œ ì˜ˆì œ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê³  ë‚˜ë‹ˆ ì‚­ì œí•  ìˆ˜ ì—†ëŠ” í˜„ìƒì„ í™•ì‹¤í•˜ê²Œ í™•ì¸í–ˆë‹¤.

* ë¡œê·¸ë¥¼ ë³´ë©´ DELETEê°€ ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ë‹¤.

  ```
  ...
  EmployeeTests > deleteEmployee() STANDARD_OUT
      Hibernate:
          select
              e1_0.id,
              e1_0.name
          from
              t_employee e1_0
          where
              e1_0.id=?
      20:10:35.612 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]
      20:10:35.615 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([1] : [INTEGER]) - [0]
      20:10:35.615 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([2] : [VARCHAR]) - [Tomcat]
      20:10:35.691 [Test worker] INFO  org.mklinkj.qna.primitive_pk.domain.EmployeeTests - Before delete. / employee id: 0: Employee(id=0, name=Tomcat)
      Hibernate:
          select
              e1_0.id,
              e1_0.name
          from
              t_employee e1_0
          where
              e1_0.id=?
      20:10:35.699 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]
      20:10:35.699 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([1] : [INTEGER]) - [0]
      20:10:35.699 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([2] : [VARCHAR]) - [Tomcat]
  
  EmployeeTests > deleteEmployee() FAILED
      org.opentest4j.AssertionFailedError at EmployeeTests.java:37
  ```

  * ê·¸ë˜ì„œ DELETE ë‹¤ìŒì˜ SELECTê°€ ì‹¤íŒ¨í•¨.



## ê²°ë¡ ì€ ...

* ê¸°ë³¸ í‚¤ê°’ìœ¼ë¡œ ì›ì‹œíƒ€ì…ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ë‚˜ì„ ê²ƒ ê°™ë‹¤. nullì„ì„ í‘œí˜„í•´ì•¼í•  ë•Œë„ ìˆëŠ” ê²ƒ ê°™ê³ ...





---

# ì§ˆë¬¸

## Spring Data JPAë¥¼ ì‚¬ìš©í•˜ë©´ì„œ  ì—”í‹°í‹°ì˜ IDê°€ ì›ì‹œíƒ€ì…ì¼ ë•Œ ì‚­ì œ ë™ì‘ ë¬¸ì˜



ì•ˆë…•í•˜ì„¸ìš”.

ë‹¨ìˆœí•˜ê²Œ JPA + Hibernateë§Œ ì‚¬ìš©í•  ë•ŒëŠ” ë³´ì§€ ëª»í•œ í˜„ìƒì¸ë°,

Spring Data JPAì˜ JpaRepositoryë¥¼ í†µí•´  IDê°€ 0ì¸ íšŒì›ì„ ì‚­ì œí•˜ë ¤í•  ë•Œ.. 

ì§€ìš¸ ìˆ˜ ì—†ë”ë¼êµ¬ìš”. 

ì—”í‹°í‹°ì˜ ID íƒ€ì…ì€ int ì˜€ìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° ì´ê±¸ Integerë¡œ ë°”ê¾¸ë©´ ì˜ ì§€ì›Œì§€ë”ë¼êµ¬ìš”.



ì—”í‹°í‹°ì— ìˆ«ìí˜• Idë¥¼ ì‚¬ìš©í•˜ëŠ” ìƒí™©ì—ì„œëŠ”, ì›ì‹œíƒ€ì…ì´ ì•„ë‹Œ ë ˆí¼ íƒ€ì…ìœ¼ë¡œ ì“°ëŠ” ê²ƒì´ ì¢‹ì€ ë°©ë²•ì´ì§€ìš”?



í…ŒìŠ¤íŠ¸ í”„ë¡œì íŠ¸

* JPA + Hibernate
  * 
* JPA + Spring Data Jpa
  * 

ê°ì‚¬í•©ë‹ˆë‹¤. ì¢‹ì€í•˜ë£¨ë˜ì„¸ìš”.

---

## Question about delete behavior when using Spring Data JPA and the entityâ€™s ID is a primitive type

Hello.

When using only JPA + Hibernate, I didnâ€™t see this  phenomenon, but when trying to delete a member with an ID of 0 through  Spring Data JPAâ€™s JpaRepository, I couldnâ€™t delete it. The ID type of  the entity was `int`. But when I changed it to `Integer`, it was deleted well.

In a situation where a numeric Id is used in an entity, is it a good way to use a reference type instead of a primitive type?

## Example project

- JPA + Hibernate
  - JPA-Hibernate.zip
    - Hibernate `6.2.7.Final`
  - https://github.com/mklinkj/QnA/tree/master/JPA/Primitive-PK-Delete/JPA-Hibernate
  - Test Code
    - https://github.com/mklinkj/QnA/blob/master/JPA/Primitive-PK-Delete/JPA-Hibernate/src/test/java/org/mklinkj/qna/primitive_pk/domain/EmployeeTests.java
- JPA + Spring Data JPA
  - JPA-Spring-Data-JPA.zip
    - Hibernate `6.2.7.Final`
    - Spring Data JPA `3.1.2`
  - https://github.com/mklinkj/QnA/tree/master/JPA/Primitive-PK-Delete/JPA-Spring-Data-JPA
  - Test Code
    - https://github.com/mklinkj/QnA/blob/master/JPA/Primitive-PK-Delete/JPA-Spring-Data-JPA/src/test/java/org/mklinkj/qna/primitive_pk/domain/EmployeeTests.java

Thank you. Have a good day.





---

* https://github.com/spring-projects/spring-data-jpa/issues/3107

ì§ˆë¬¸ì„ ì˜¬ë¦¬ê¸´ í–ˆì€ë° stackoverflow íƒœê¹… ë‹¬ë¦´ ê²ƒ ê°™ìŒ..ğŸ˜…

---

ê°ì‚¬í•´ê²Œë„ ê°œë°œìë‹˜ê»˜ì„œ ë‹µë³€ì„ ë¹ ë¥´ê²Œ ì£¼ì…¨ë‹¤.ğŸ‘ğŸ‘ğŸ‘

> Spring Data assumes that a primitive identifier set to its default value indicates an entity that is new (i.e. not saved). If you use wrapper types (Integer), then its default value is null. In that case, an entity with the identifier value 0 (zero) is considered not new as the identifier value isn't the default.
>
> The delete method doesn't remove entities that are considered new. If your objects use identifiers that can be set to their default value, either use the Integer wrapper type or let your entities implement Persistable to hint Spring Data whether the object instance is new.

* Spring DataëŠ” ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ëœ ì›ì‹œ ì‹ë³„ì(int)ê°€ ìƒˆë¡œìš´(ì¦‰, ì €ì¥ë˜ì§€ ì•Šì€) ì—”í„°í‹°ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤ê³  ê°€ì •í•¨.
  * intì˜ ê¸°ë³¸ ê°’ì€ 0.
  * Integerë¼ë©´ nullì´ ê¸°ë³¸ ê°’ì´ê¸° ë•Œë¬¸ì— 0ì´ ì„¤ì •ë˜ë”ë¼ë„ ìƒˆë¡œìš´ ì—”í‹°í‹°ë¡œ ê°„ì£¼í•˜ì§€ ì•ŠìŒ.
* delete ë©”ì„œë“œëŠ” ìƒˆ ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ëŠ” ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ì§€ ì•ŠìŒ.
* ê°œë°œìë‹˜ ë‹µë³€ ëŒ€ë¡œ `Persistable`ë¥¼ ì—”í‹°í‹°ì— êµ¬í˜„í•´ì¤˜ë„ ë˜ëŠ” ê²ƒì„ í™•ì¸í–ˆë‹¤. ê·¸ëŸ¬ë‚˜ ... Wrapper íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ”ê²Œ ì œì¼ ë‚˜ì€ ê²ƒ ê°™ë‹¤. 
* ì—­ì‹œ íƒœê·¸ ë‹¬ì•„ì£¼ì…¨ë„¤ ğŸ˜… Stackoverflowë„ ê°€ì…ì„ í•´ì•¼ê² ë‹¤. ğŸ˜…

