# Spring JPA Data엔티티의 정수형 기본키를 래퍼(Wrapper) 타입이 아닌 원시(Primitive)로 사용할 때.. 기본키 값이 0이라면 삭제가 안되는 현상

> Spring JPA Data 메서드로 삭제를 했을 때.. 이상하게 안되었던 기억이 나서...
>
> 이번에 한번 테스트 하기로함.



## 엔티티 클래스

```java
@Entity
@Table(name = "t_employee")
public class Employee {
  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  private int id; // 원시 타입으로 설정

  private String name;
}
```





## DB의 기본 상태

테스트 시작 전에 초기 데이터를 넣어주는 스크립트 실행

```sql
DROP TABLE IF EXISTS t_employee CASCADE;
CREATE TABLE IF NOT EXISTS t_employee (
    id    BIGINT        GENERATED BY DEFAULT AS IDENTITY(START WITH 0) PRIMARY KEY,
    name  VARCHAR(255)
);

INSERT INTO t_employee (name) VALUES ('Tomcat');
INSERT INTO t_employee (name) VALUES ('Struts');
INSERT INTO t_employee (name) VALUES ('Spring');
```



## 1. JPA Hibernate 프로젝트 (Spring JPA 미사용)

테스트 코드 실행순서는 아래와 같이 했다.

1. id가 `0`인 사원 조회일 때 조회된 사원이 있는지 확인
2. remove()로 id `0`인 사원 삭제
3. 커밋
4. id가 `0`인 사원 조회 했을 때.. 결과가 null 인지 확인

#### 앗!!! 그런데... 2. 부분에서 삭제가 제대로 안될 것이란 생각이 들었는데... 삭제가 제대로 된다.

```
  ### (1) 에서 id가 0인 사원 조회: 조회됨 ###
   ...
   Hibernate:
        select
            e1_0.id,
            e1_0.name
        from
            t_employee e1_0
        where
            e1_0.id=?
    05:02:15.311 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]
    05:02:15.313 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([1] : [INTEGER]) - [0]
    05:02:15.313 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([2] : [VARCHAR]) - [Tomcat]
    05:02:15.331 [Test worker] INFO  org.mklinkj.qna.primitive_pk.domain.EmployeeTests - 1st employee id: 0: Employee(id=0, name=Tomcat)
    ....
    
    ### (2) id가 0인 사원 삭제 ###
    ### (3) 커밋을 했으니까 쿼리 로그가 실행된 것을 확인.
    Hibernate:
        delete
        from
            t_employee
        where
            id=?
    05:02:15.444 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]

    
    ### (4) id가 0인 사원 확인 결과: null. ###
    Hibernate:
        select
            e1_0.id,
            e1_0.name
        from
            t_employee e1_0
        where
            e1_0.id=?
    05:02:15.451 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]
    05:02:15.451 [Test worker] INFO  org.mklinkj.qna.primitive_pk.domain.EmployeeTests - 2nd employee id: 0: null
    05:02:15.452 [Test worker] INFO  org.hibernate.orm.connections.pooling - HHH10001008: Cleaning up connection pool [jdbc:hsqldb:mem:test]
```



아직 Spring Data JPA프로젝트는 예제는 아직 안만들었는데... 재확인 해봐야겠다. 👍





## 2. JPA Spring Data JPA 프로젝트

* 예전 기억이 틀렸나 했는데, Spring Data JPA 를 적용한 예제 프로젝트를 만들고 나니 삭제할 수 없는 현상을 확실하게 확인했다.

* 로그를 보면 DELETE가 수행되지 않았다.

  ```
  ...
  EmployeeTests > deleteEmployee() STANDARD_OUT
      Hibernate:
          select
              e1_0.id,
              e1_0.name
          from
              t_employee e1_0
          where
              e1_0.id=?
      20:10:35.612 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]
      20:10:35.615 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([1] : [INTEGER]) - [0]
      20:10:35.615 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([2] : [VARCHAR]) - [Tomcat]
      20:10:35.691 [Test worker] INFO  org.mklinkj.qna.primitive_pk.domain.EmployeeTests - Before delete. / employee id: 0: Employee(id=0, name=Tomcat)
      Hibernate:
          select
              e1_0.id,
              e1_0.name
          from
              t_employee e1_0
          where
              e1_0.id=?
      20:10:35.699 [Test worker] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [INTEGER] - [0]
      20:10:35.699 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([1] : [INTEGER]) - [0]
      20:10:35.699 [Test worker] TRACE org.hibernate.orm.jdbc.extract - extracted value ([2] : [VARCHAR]) - [Tomcat]
  
  EmployeeTests > deleteEmployee() FAILED
      org.opentest4j.AssertionFailedError at EmployeeTests.java:37
  ```

  * 그래서 DELETE 다음의 SELECT가 실패함.



## 결론은 ...

* 기본 키값으로 원시타입을 사용하지 않는 것이 나을 것 같다. null임을 표현해야할 때도 있는 것 같고...





---

# 질문

## Spring Data JPA를 사용하면서  엔티티의 ID가 원시타입일 때 삭제 동작 문의



안녕하세요.

단순하게 JPA + Hibernate만 사용할 때는 보지 못한 현상인데,

Spring Data JPA의 JpaRepository를 통해  ID가 0인 회원을 삭제하려할 때.. 

지울 수 없더라구요. 

엔티티의 ID 타입은 int 였습니다.

그런데 이걸 Integer로 바꾸면 잘 지워지더라구요.



엔티티에 숫자형 Id를 사용하는 상황에서는, 원시타입이 아닌 레퍼 타입으로 쓰는 것이 좋은 방법이지요?



테스트 프로젝트

* JPA + Hibernate
  * 
* JPA + Spring Data Jpa
  * 

감사합니다. 좋은하루되세요.

---

## Question about delete behavior when using Spring Data JPA and the entity’s ID is a primitive type

Hello.

When using only JPA + Hibernate, I didn’t see this  phenomenon, but when trying to delete a member with an ID of 0 through  Spring Data JPA’s JpaRepository, I couldn’t delete it. The ID type of  the entity was `int`. But when I changed it to `Integer`, it was deleted well.

In a situation where a numeric Id is used in an entity, is it a good way to use a reference type instead of a primitive type?

## Example project

- JPA + Hibernate
  - JPA-Hibernate.zip
    - Hibernate `6.2.7.Final`
  - https://github.com/mklinkj/QnA/tree/master/JPA/Primitive-PK-Delete/JPA-Hibernate
  - Test Code
    - https://github.com/mklinkj/QnA/blob/master/JPA/Primitive-PK-Delete/JPA-Hibernate/src/test/java/org/mklinkj/qna/primitive_pk/domain/EmployeeTests.java
- JPA + Spring Data JPA
  - JPA-Spring-Data-JPA.zip
    - Hibernate `6.2.7.Final`
    - Spring Data JPA `3.1.2`
  - https://github.com/mklinkj/QnA/tree/master/JPA/Primitive-PK-Delete/JPA-Spring-Data-JPA
  - Test Code
    - https://github.com/mklinkj/QnA/blob/master/JPA/Primitive-PK-Delete/JPA-Spring-Data-JPA/src/test/java/org/mklinkj/qna/primitive_pk/domain/EmployeeTests.java

Thank you. Have a good day.





---

* https://github.com/spring-projects/spring-data-jpa/issues/3107

질문을 올리긴 했은데 stackoverflow 태깅 달릴 것 같음..😅

---

감사해게도 개발자님께서 답변을 빠르게 주셨다.👍👍👍

> Spring Data assumes that a primitive identifier set to its default value indicates an entity that is new (i.e. not saved). If you use wrapper types (Integer), then its default value is null. In that case, an entity with the identifier value 0 (zero) is considered not new as the identifier value isn't the default.
>
> The delete method doesn't remove entities that are considered new. If your objects use identifiers that can be set to their default value, either use the Integer wrapper type or let your entities implement Persistable to hint Spring Data whether the object instance is new.

* Spring Data는 기본값으로 설정된 원시 식별자(int)가 새로운(즉, 저장되지 않은) 엔터티를 나타낸다고 가정함.
  * int의 기본 값은 0.
  * Integer라면 null이 기본 값이기 때문에 0이 설정되더라도 새로운 엔티티로 간주하지 않음.
* delete 메서드는 새 것으로 간주되는 엔티티를 제거하지 않음.
* 개발자님 답변 대로 `Persistable`를 엔티티에 구현해줘도 되는 것을 확인했다. 그러나 ... Wrapper 타입을 사용하는게 제일 나은 것 같다. 
* 역시 태그 달아주셨네 😅 Stackoverflow도 가입을 해야겠다. 😅

